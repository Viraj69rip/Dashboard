<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Void Store Dashboard</title>

  <!-- FAVICON / APP ICONS -->
  <link rel="icon" href="https://i.ibb.co/sJqfn3w5/1761541971985.png" type="image/png">
  <link rel="apple-touch-icon" sizes="180x180" href="https://i.ibb.co/sJqfn3w5/1761541971985.png">
  <meta name="msapplication-TileImage" content="https://i.ibb.co/sJqfn3w5/1761541971985.png">

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --accent:#10a37f;
      --muted:#9aa1a6;
      --bg:#e4e7eb;
      --glass: rgba(255,255,255,0.36);
      --glass-2: rgba(255,255,255,0.22);
      --card-border: rgba(255,255,255,0.36);
    }

    /* base */
    *{box-sizing:border-box;font-family:Inter,system-ui,Arial,Helvetica,sans-serif}
    html,body{height:100%;margin:0;background:linear-gradient(135deg,#c9d6ff 0%, #e2e2f0 100%);color:#222}
    h1,h2,h3,h4,h5,h6{margin:0;padding:0}
    button{cursor:pointer}

    /* layout */
    .layout{display:flex;min-height:100vh;align-items:stretch}
    .sidebar{
      width:220px;padding:26px;border-right:1px solid rgba(255,255,255,0.28);
      background:var(--glass-2);backdrop-filter:blur(10px);flex-shrink:0;
      box-shadow: 0 6px 20px rgba(12,24,40,0.03);
    }
    .logo{display:flex;align-items:center;gap:10px;font-weight:800;color:var(--accent);margin-bottom:20px;font-size:18px}
    .logo img{height:36px;width:36px;border-radius:8px;object-fit:cover;box-shadow:0 4px 12px rgba(0,0,0,0.08)}
    .nav a{
      display:block;padding:10px 8px;border-radius:10px;text-decoration:none;margin-bottom:8px;color:#223;font-weight:600;
      transition:all .22s ease;
    }
    .nav a:hover{transform:translateX(6px);opacity:.95}
    .nav a.active{background:rgba(16,163,127,0.16);color:var(--accent);box-shadow: inset 0 -2px 0 rgba(0,0,0,0.02)}

    .main{flex:1;padding:26px 34px;min-width:0;min-height:100vh}

    /* top cards */
    .top{display:flex;gap:18px;flex-wrap:wrap;margin-bottom:18px}
    .card{
      flex:1;min-width:220px;padding:18px;border-radius:14px;border:1px solid var(--card-border);
      background:var(--glass);backdrop-filter:blur(10px);box-shadow: 0 8px 30px rgba(20,30,60,0.04);
      transform:translateY(6px);opacity:0;animation:fadeInUp .44s ease forwards;
    }
    .card:nth-child(2){animation-delay:.06s}
    .card:nth-child(3){animation-delay:.12s}
    .card h4{margin:0;color:#445;font-size:14px;font-weight:700}
    .big{font-size:20px;margin-top:8px;font-weight:800}

    @keyframes fadeInUp{
      from { transform: translateY(10px); opacity:0 }
      to   { transform: translateY(0);  opacity:1 }
    }

    .content{display:flex;gap:20px;align-items:flex-start}
    .left{flex:1;min-width:0}
    .right{width:360px;flex-shrink:0}

    /* panels */
    .panel{
      background:var(--glass);border:1px solid var(--card-border);backdrop-filter:blur(12px);
      padding:18px;border-radius:14px;margin-bottom:18px;box-shadow:0 6px 20px rgba(0,0,0,0.04);
      transform:translateY(8px);opacity:0;animation:fadeInUp .46s ease forwards;
    }
    .panel:nth-of-type(1){animation-delay:.06s}
    .panel h3{font-size:18px;margin-bottom:8px;color:#1f2937}

    /* table */
    table{width:100%;border-collapse:collapse;margin-top:8px;table-layout:fixed}
    thead th{
      padding:12px 12px;font-size:13px;color:#475569;border-bottom:1px solid rgba(0,0,0,0.05);
      text-align:left;font-weight:700; background:transparent;
    }
    tbody td{
      padding:14px 12px;border-bottom:1px solid rgba(0,0,0,0.03);font-size:14px;color:#28343a;
      vertical-align:middle;
      transition:background .18s ease, transform .12s ease;
    }
    tbody tr:hover td{ background: rgba(255,255,255,0.28); transform: translateX(2px); }

    /* column widths and spacing */
    thead th:nth-child(1), tbody td:nth-child(1){ width:6%; text-align:center }
    thead th:nth-child(2), tbody td:nth-child(2){ width:38%; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    thead th:nth-child(3), tbody td:nth-child(3){ width:18%; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; } /* status */
    thead th:nth-child(4), tbody td:nth-child(4){ width:12%; text-align:right; padding-right:22px; } /* profit */
    thead th:nth-child(5), tbody td:nth-child(5){ width:12%; text-align:right; padding-right:22px; } /* platform fees */
    thead th:nth-child(6), tbody td:nth-child(6){ width:18%; text-align:right; padding-left:18px; color:#4b5563; } /* date */

    .col-number{ font-weight:700; color:#374151; }
    .col-profit{ text-align:right; padding-right:22px; font-weight:600 }
    .col-date{ font-size:13px; color:#374151; white-space:nowrap; text-align:right }

    /* ensure headers + cells vertically centered */
    thead th, tbody td { vertical-align: middle; }

    /* badges */
    .status-badge{padding:6px 12px;border-radius:12px;font-weight:700;font-size:13px;display:inline-block}
    .status-paid{background:rgba(16,163,127,0.12);color:#056a52;border:1px solid rgba(16,163,127,0.09)}
    .status-pending{background:rgba(244,197,61,0.12);color:#8b5e00;border:1px solid rgba(244,197,61,0.08)}
    .status-active{background:rgba(16,163,127,0.12);color:#056a52;border:1px solid rgba(16,163,127,0.09)}
    .status-badge{transform:scale(.96);transition:transform .18s ease}
    .status-badge:hover{transform:scale(1)}

    /* search */
    .search-row{display:flex;gap:10px;align-items:center;margin-bottom:12px}
    .search-input{flex:1;padding:12px 14px;border-radius:12px;border:1px solid rgba(0,0,0,0.04);background:rgba(255,255,255,0.28);}

    /* button for row */
    .row-link{
      display:inline-block;padding:6px 8px;border-radius:8px;background:rgba(255,255,255,0.12);border:1px solid rgba(0,0,0,0.04);
      font-weight:700;color:#0a2540;text-decoration:none;cursor:pointer;
    }
    .row-link:hover{background:rgba(255,255,255,0.22);transform:translateY(-2px)}

    /* iframe area */
    .iframe-container{position:relative;width:100%;min-height:640px;overflow:auto;border-radius:12px;border:1px solid var(--card-border);background:var(--glass-2);padding:12px}
    .iframe-inner{width:100%;height:820px;border:0;display:block}

    /* analytics chart area */
    .analytics-chart { width:100%; height:420px; }

    /* right column sticky */
    .right .panel{position:sticky;top:22px}

    /* fix: ensure small side charts have a stable height to avoid canvas stretching issues */
    .right panel, .right .panel { min-height:340px; }
    /* specifically force canvas height so ChartJS doesn't stretch it weirdly */
    #profitChart, #analyticsChart { width:100% !important; height:320px !important; display:block; }

    /* animation helpers for nav change */
    .view{display:none;opacity:0;transform:translateY(6px);transition:opacity .28s ease, transform .28s ease}
    .view.active{display:block;opacity:1;transform:none}

    /* subtle hover for cards/panels */
    .card:hover, .panel:hover{transform:translateY(-4px);box-shadow:0 14px 40px rgba(11,26,40,0.06)}

    /* fonts & small */
    .small{font-size:13px;color:#6b7280}

    @media(max-width:1100px){
      .right{width:320px}
      thead th:nth-child(2){width:40%}
      thead th:nth-child(3){width:30%}
    }
    @media(max-width:900px){
      .layout{flex-direction:column}
      .sidebar{width:100%;display:flex;flex-direction:row;gap:12px;align-items:center}
      .nav{display:flex;gap:8px}
      .main{padding:18px}
      .content{flex-direction:column}
      .right{width:100%}
      .iframe-inner{height:1200px}
      .iframe-container{min-height:460px}
      thead th:nth-child(2){width:50%}
      thead th:nth-child(3){width:30%}
    }

  </style>
</head>
<body>
  <div class="layout">
    <aside class="sidebar">
      <div class="logo">
        <img src="https://i.ibb.co/sJqfn3w5/1761541971985.png" alt="Void Logo">
        <span>Void Store</span>
      </div>
      <nav class="nav" aria-label="main nav">
        <a id="nav-dashboard" class="active">Dashboard</a>
        <a id="nav-customer">Customer Data</a>
        <a id="nav-entry">Entry Form</a>
        <a id="nav-invoice">Invoice Generator</a>
        <a id="nav-sheet">Sheet View</a>
        <a id="nav-analytics">Analytics</a>
      </nav>
    </aside>

    <main class="main">
      <!-- Dashboard view -->
      <section id="view-dashboard" class="view active">
        <div class="top">
          <div class="card"><h4>Total Earning</h4><div class="big" id="totalEarning">₹ 0.00</div></div>
          <div class="card"><h4>Total Orders</h4><div class="big" id="totalOrders">0</div></div>
          <div class="card"><h4>Total Profit</h4><div class="big" id="totalProfitTop">₹ 0.00</div></div>
        </div>

        <div class="content">
          <div class="left">
            <div class="panel">
              <h3>Active Listing</h3>
              <table id="entriesTableDashboard" aria-describedby="Active Listing">
                <thead>
                  <tr>
                    <th>No.</th>
                    <th>Sub. Name</th>
                    <th>Status</th>
                    <th style="text-align:right">Profit</th>
                    <th style="text-align:right">Platform Fees</th>
                    <th class="col-date">Date</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>

          <aside class="right">
            <div class="panel">
              <h3>Profit by Product</h3>
              <canvas id="profitChart"></canvas>
            </div>

            <div class="panel">
              <h3>Overview</h3>
              <p class="small">Total Entries: <b id="countEntries">0</b></p>
              <p class="small">Total Profit: <b id="totalProfit">₹ 0.00</b></p>
            </div>
          </aside>
        </div>
      </section>

      <!-- Customer Data view -->
      <section id="view-customer" class="view" aria-hidden="true">
        <div class="panel">
          <h3>Customer Data</h3>
          <div class="search-row">
            <input id="customerSearch" class="search-input" placeholder="Search customer..." />
            <button id="clearSearch" style="padding:10px 14px;border-radius:10px;border:1px solid rgba(0,0,0,0.04);background:var(--glass-2)">Clear</button>
          </div>

          <div style="overflow:auto">
            <table id="customerTable" aria-describedby="Customer Data">
              <thead>
                <tr>
                  <th>No.</th>
                  <th>Customer</th>
                  <th>Product</th>
                  <th style="text-align:right">Price</th>
                  <th style="text-align:right">Platform Fees</th>
                  <th style="text-align:right">Profit</th>
                  <th class="col-date">Date</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- Entry Form view (embedded google form) -->
      <section id="view-entry" class="view" aria-hidden="true">
        <div class="panel">
          <h3>Entry Form</h3>
          <div class="iframe-container">
            <iframe class="iframe-inner"
                    src="https://docs.google.com/forms/d/e/1FAIpQLSeOAk5-YgxpVINsL6v3_c2ggwS_MZ_iDQRz1679hAxW6DcgUw/viewform?embedded=true"
                    title="Entry Form"></iframe>
          </div>
        </div>
      </section>

      <!-- Invoice Generator view (embedded external page) -->
      <section id="view-invoice" class="view" aria-hidden="true">
        <div class="panel">
          <h3>Invoice Generator</h3>
          <div class="iframe-container">
            <iframe id="invoiceIframe" class="iframe-inner"
              src="https://viraj69rip.github.io/Invoice-From-Void-PC-Games/"
              title="Invoice Generator - Void PC Games"></iframe>
          </div>
        </div>
      </section>

      <!-- Sheet View (embedded published Sheet) -->
      <section id="view-sheet" class="view" aria-hidden="true">
        <div class="panel">
          <h3>Sheet View (embedded)</h3>

          <div style="display:flex;gap:10px;align-items:center;margin-bottom:10px">
            <button id="openSheetBtn" style="padding:8px 12px;border-radius:8px;border:1px solid rgba(0,0,0,0.05);background:var(--glass-2)">Open Sheet in new tab</button>
            <span class="small" style="color:#475569">Published view is embedded below.</span>
          </div>

          <div class="iframe-container" style="min-height:560px">
            <iframe id="sheetIframe" class="iframe-inner"
              src=""
              title="Google Sheet - embedded"></iframe>
          </div>
        </div>
      </section>

      <!-- Analytics view -->
      <section id="view-analytics" class="view" aria-hidden="true">
        <div class="panel" style="margin-bottom:24px;">
          <h2>Analytics</h2>
          <p class="small">Overview and sales timeline</p>

          <div class="top" style="margin-top:18px;">
            <div class="card"><h4>Total revenues</h4><div class="big" id="analyticsTotalRevenue">₹ 0.00</div><div class="small"> </div></div>
            <div class="card"><h4>Total sales</h4><div class="big" id="analyticsTotalSales">0</div><div class="small"> </div></div>
            <div class="card"><h4>AOV</h4><div class="big" id="analyticsAOV">₹ 0.00</div><div class="small"> </div></div>
            <div class="card"><h4>Total Profit</h4><div class="big" id="analyticsTotalProfit">₹ 0.00</div><div class="small"> </div></div>
          </div>
        </div>

        <div class="panel">
          <h3>Sales timeline</h3>
          <div class="analytics-chart">
            <canvas id="analyticsChart"></canvas>
          </div>
        </div>
      </section>

    </main>
  </div>

<script>
/* ---------- config ---------- */
const SHEET_ID = "1Eat5aTUzw6Ck2fZG-Vf_d1g9WAMFTlNcZd0yLiotUJw";
const SHEET_NAME = "Form responses 1";
// Published URL you gave (used for sheet embed)
const PUBLISHED_SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTP0XFeoA6vDt9mdjZyoXnUDBw3Whx5epnX0zvhvSdGDwnvQ7jBm-vEtHlzDA1q1nGCVxYVsanny9Ik/pubhtml?gid=2126430015&single=true";
const FEED_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(SHEET_NAME)}`;

/* ---------- helpers ---------- */
function escapeHtml(s){ return (s||"").toString().replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function formatINR(n){ return "₹ "+Number(n||0).toLocaleString("en-IN",{minimumFractionDigits:2}); }
function parseGoogleJSON(txt){ const s=txt.indexOf("{"), e=txt.lastIndexOf("}"); return JSON.parse(txt.slice(s,e+1)); }

/* Robust date parser -> outputs dd/mm/yy and time */
function parseDT(cell){
  if(!cell) return {date:"", time:""};
  if(typeof cell.f === 'string'){
    const f = cell.f.trim();
    let m = f.match(/(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})(?:\s+(\d{1,2}:\d{2}(?::\d{2})?))?/);
    if(m){
      const d = m[1].padStart(2,'0'), mo = m[2].padStart(2,'0'), yy = (String(m[3]).length===4?String(m[3]).slice(2):String(m[3]).padStart(2,'0'));
      const time = m[4] || "";
      return { date: `${d}/${mo}/${yy}`, time };
    }
    if(f.includes("Date(")){
      const nums = (f.match(/\d+/g)||[]).map(Number);
      if(nums.length >= 3){
        const y = nums[0], m0 = nums[1], d = nums[2];
        const hh = nums[3]||0, mm = nums[4]||0, ss = nums[5]||0;
        const mo = String(m0+1).padStart(2,'0');
        return { date: `${String(d).padStart(2,'0')}/${mo}/${String(y).slice(2)}`, time: `${String(hh).padStart(2,'0')}:${String(mm).padStart(2,'0')}:${String(ss).padStart(2,'0')}` };
      }
    }
  }
  if(typeof cell.v === 'string'){
    const s = cell.v.trim();
    const iso = s.match(/^(\d{4})-(\d{2})-(\d{2})[T ](\d{2}):(\d{2}):(\d{2})/);
    if(iso){
      const y = iso[1], mo = iso[2], d = iso[3], hh = iso[4], mm = iso[5], ss = iso[6];
      return { date: `${d}/${mo}/${y.slice(2)}`, time: `${hh}:${mm}:${ss}` };
    }
    const m2 = s.match(/(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})(?:\s+(\d{1,2}:\d{2}(?::\d{2})?))?/);
    if(m2){
      const d = m2[1].padStart(2,'0'), mo = m2[2].padStart(2,'0'), yy = (String(m2[3]).length===4?String(m2[3]).slice(2):String(m2[3]).padStart(2,'0'));
      return { date: `${d}/${mo}/${yy}`, time: (m2[4]||"") };
    }
  }
  return { date:"", time:"" };
}

/* convert dd/mm/yy (or dd/mm/yyyy) to ISO yyyy-mm-dd */
function toISODate(ddmmyy){
  if(!ddmmyy) return "";
  const parts = ddmmyy.split('/');
  if(parts.length < 3) return ddmmyy;
  let d = parts[0].padStart(2,'0'), m = parts[1].padStart(2,'0'), y = parts[2];
  if(y.length === 2) y = (Number(y) > 50 ? '19'+y : '20'+y);
  return `${y}-${m}-${d}`;
}

/* ---------- view & nav ---------- */
const views = {
  dashboard: document.getElementById('view-dashboard'),
  customer: document.getElementById('view-customer'),
  entry: document.getElementById('view-entry'),
  invoice: document.getElementById('view-invoice'),
  sheet: document.getElementById('view-sheet'),
  analytics: document.getElementById('view-analytics')
};
const navEls = {
  dashboard: document.getElementById('nav-dashboard'),
  customer: document.getElementById('nav-customer'),
  entry: document.getElementById('nav-entry'),
  invoice: document.getElementById('nav-invoice'),
  sheet: document.getElementById('nav-sheet'),
  analytics: document.getElementById('nav-analytics')
};

function showView(name){
  Object.values(views).forEach(v => { if(v){ v.classList.remove('active'); v.style.display='none'; v.setAttribute('aria-hidden','true'); }});
  const next = views[name];
  if(next){ next.style.display='block'; void next.offsetHeight; next.classList.add('active'); next.setAttribute('aria-hidden','false'); }
  Object.values(navEls).forEach(n => { if(n) n.classList.remove('active') });
  if(navEls[name]) navEls[name].classList.add('active');
  try{ window.scrollTo({top:0,left:0,behavior:'instant'}) } catch(e){ window.scrollTo(0,0) }
  // fetch fresh data so charts update when switching
  fetchAndRender();
}

navEls.dashboard.addEventListener('click', ()=> showView('dashboard'));
navEls.customer.addEventListener('click', ()=> showView('customer'));
navEls.entry.addEventListener('click', ()=> showView('entry'));
navEls.invoice.addEventListener('click', ()=> showView('invoice'));
navEls.sheet.addEventListener('click', ()=> showView('sheet'));
navEls.analytics.addEventListener('click', ()=> showView('analytics'));

/* ---------- fetch & render (robust header lookup) ---------- */
let customerRowsCache = []; // will hold original array from sheet
let headerIndex = {};       // header label (upper) => index in r.c[]
let analyticsChart = null;
let profitChart = null;

/**
 * Build headerIndex map from gviz JSON table.cols
 */
function buildHeaderMap(json){
  headerIndex = {};
  if(!json || !json.table || !Array.isArray(json.table.cols)) return;
  json.table.cols.forEach((col, i) => {
    const label = (col.label || '').toString().trim().toUpperCase();
    if(label) headerIndex[label] = i;
  });
}

/**
 * getCell - safe cell getter by header name
 * row: json.table.rows[n]
 * hdr: header name e.g. "PLATFORM FEES" or "PRODUCT SELL PRICE"
 * options:
 *   { asNumber: boolean } -> when true returns Number(cell.v || 0)
 */
function getCell(row, hdr, options = {}){
  if(!row) return options.asNumber ? 0 : '';
  const idx = headerIndex[hdr.toUpperCase()];
  if(idx === undefined) {
    return options.asNumber ? 0 : '';
  }
  const cell = row.c?.[idx];
  if(!cell) return options.asNumber ? 0 : '';
  if(options.asNumber){
    const v = Number(cell.v ?? 0);
    return isNaN(v) ? 0 : v;
  }
  return cell.v ?? (cell.f ?? '');
}

/* new fetch + render */
function fetchAndRender(){
  fetch(FEED_URL).then(r => r.text()).then(txt => {
    const json = parseGoogleJSON(txt);
    buildHeaderMap(json);

    const rows = json.table.rows || [];
    customerRowsCache = rows.slice();

    renderDashboard(rows);
    renderCustomer(rows);
    renderAnalytics(rows);
  }).catch(err=>{
    console.error("Sheet fetch error:", err);
  });
}
fetchAndRender();

/* Badge helper */
function badge(status){
  if(!status) return '';
  const s = status.toString().toLowerCase();
  if(s.includes('pending')) return `<span class="status-badge status-pending">Pending</span>`;
  if(s.includes('paid')) return `<span class="status-badge status-paid">Paid</span>`;
  if(s.includes('active')) return `<span class="status-badge status-active">Active</span>`;
  return escapeHtml(status);
}

/* ---------- number animation helper ---------- */
function animateValue(element, start, end, duration = 800, formatter = (n)=>String(n)) {
  const startTime = performance.now();
  const isInt = Number.isInteger(start) && Number.isInteger(end);
  function easeOutCubic(t){ return 1 - Math.pow(1 - t, 3); }
  function step(now) {
    const elapsed = now - startTime;
    const progress = Math.min(1, elapsed / duration);
    const eased = easeOutCubic(progress);
    const current = start + (end - start) * eased;
    element.textContent = formatter(isInt ? Math.round(current) : current);
    if(progress < 1) requestAnimationFrame(step);
  }
  requestAnimationFrame(step);
}

/* ---------- renderDashboard (using header map) ---------- */
function renderDashboard(rows){
  const tbody = document.querySelector("#entriesTableDashboard tbody");
  if(!tbody) return;
  tbody.innerHTML = "";
  let totalEarning = 0, totalProfit = 0;
  const productProfit = {};

  rows.forEach((r, idx) => {
    const dtCell = r.c?.[ headerIndex['TIMESTAMP'] ];
    const dt = parseDT(dtCell);
    const product = String(getCell(r, 'PRODUCT NAME') || getCell(r, 'PRODUCT') || '').toString();
    const buy = Number(getCell(r, 'PRODUCT BUY PRICE', {asNumber:true}) || 0);
    const sell = Number(getCell(r, 'PRODUCT SELL PRICE', {asNumber:true}) || 0);
    const platformFees = Number(getCell(r, 'PLATFORM FEES', {asNumber:true}) || 0);
    const status = String(getCell(r, 'PAYMENT STATUS') || getCell(r, 'STATUS') || '');

    const explicitProfit = Number(getCell(r, 'PROFITS', {asNumber:true}));
    const profit = (!isNaN(explicitProfit) && explicitProfit !== 0) ? explicitProfit : (sell - buy - platformFees || 0);

    totalEarning += sell;
    totalProfit += profit;
    productProfit[product] = (productProfit[product] || 0) + profit;

    const sheetRow = idx + 2;

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="col-number"><a class="row-link" data-row="${sheetRow}">${sheetRow}</a></td>
      <td>${escapeHtml(product)}</td>
      <td>${badge(status)}</td>
      <td class="col-profit">${formatINR(profit)}</td>
      <td class="col-profit">${formatINR(platformFees)}</td>
      <td class="col-date">${escapeHtml(dt.date)}</td>
    `;
    tbody.appendChild(tr);
  });

  const totalEarningEl = document.getElementById('totalEarning');
  const totalOrdersEl = document.getElementById('totalOrders');
  const totalProfitTopEl = document.getElementById('totalProfitTop');

  animateValue(totalEarningEl, 0, totalEarning, 900, (n)=>formatINR(n));
  animateValue(totalOrdersEl, 0, rows.length, 700, (n)=>String(n));
  animateValue(totalProfitTopEl, 0, totalProfit, 900, (n)=>formatINR(n));

  document.getElementById('countEntries').innerText = rows.length;
  const totalProfitEl = document.getElementById('totalProfit');
  if(totalProfitEl) totalProfitEl.innerText = formatINR(totalProfit);

  renderProfitByProductChart(productProfit);
  wireRowLinks();
}

/* ---------- renderCustomer (using header map) ---------- */
function renderCustomer(rows){
  const tbody = document.querySelector("#customerTable tbody");
  if(!tbody) return;
  tbody.innerHTML = "";
  rows.forEach((r, idx) => {
    const dt = parseDT(r.c?.[ headerIndex['TIMESTAMP'] ]);
    const customer = String(getCell(r, 'NAME OF CUSTOMER') || getCell(r, 'NAME') || '');
    const product = String(getCell(r, 'PRODUCT NAME') || getCell(r, 'PRODUCT') || '');
    const price = Number(getCell(r, 'PRODUCT SELL PRICE', {asNumber:true}) || 0);
    const platformFees = Number(getCell(r, 'PLATFORM FEES', {asNumber:true}) || 0);
    const explicitProfit = Number(getCell(r, 'PROFITS', {asNumber:true}));
    const profit = (!isNaN(explicitProfit) && explicitProfit !== 0) ? explicitProfit : (price - Number(getCell(r,'PRODUCT BUY PRICE',{asNumber:true})||0) - platformFees);

    const sheetRow = idx + 2;

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="col-number"><a class="row-link" data-row="${sheetRow}">${sheetRow}</a></td>
      <td>${escapeHtml(customer)}</td>
      <td>${escapeHtml(product)}</td>
      <td class="col-profit">${formatINR(price)}</td>
      <td class="col-profit">${formatINR(platformFees)}</td>
      <td class="col-profit">${formatINR(profit)}</td>
      <td class="col-date">${escapeHtml(dt.date)}</td>
    `;
    tbody.appendChild(tr);
  });
  wireRowLinks();
}

/* ---------- Profit by Product chart (right panel) ----------
   Fixes applied:
   - Set maintainAspectRatio:false so canvas height is respected
   - Compute reasonable suggestedMax so single bars don't blow chart scale
   - Set maxBarThickness so bars don't become huge
*/
function renderProfitByProductChart(obj){
  const canvas = document.getElementById("profitChart");
  if(!canvas) return;
  if(profitChart) profitChart.destroy();

  const labels = Object.keys(obj).filter(l => l && l.trim() !== '').length ? Object.keys(obj) : ['No data'];
  const data = labels.map(l => obj[l] || 0);

  // compute a reasonable suggested max so big single bar doesn't make chart vertical-only
  const maxVal = data.length ? Math.max(...data.map(v => Math.abs(v))) : 0;
  const suggestedMax = Math.ceil(maxVal * 1.25) || 10; // fallback to 10 if all zeros

  profitChart = new Chart(canvas.getContext('2d'), {
    type:'bar',
    data:{
      labels: labels,
      datasets:[{
        label:'Profit',
        data: data,
        backgroundColor:'rgba(16,163,127,0.55)',
        borderRadius: 6
      }]
    },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      plugins:{ legend:{ display:false } },
      scales:{
        y:{
          beginAtZero:true,
          suggestedMax: suggestedMax,
          grid:{ color: 'rgba(0,0,0,0.03)' }
        },
        x:{
          grid:{ display:false }
        }
      },
      elements:{
        bar:{ maxBarThickness: 48 } // restrict bar width
      }
    }
  });
}

/* ---------- Analytics rendering & chart ----------
   Also now shows Total Profit in the top right card (analyticsTotalProfit).
*/
function renderAnalytics(rows){
  if(!rows) rows = [];
  const revenueByDate = {};
  const salesByDate = {};
  let totalRevenue = 0;
  let totalSales = 0;
  let totalProfit = 0;
  const productsSet = new Set();

  rows.forEach(r => {
    const dt = parseDT(r.c?.[ headerIndex['TIMESTAMP'] ]);
    const iso = toISODate(dt.date) || 'unknown';
    const sell = Number(getCell(r, 'PRODUCT SELL PRICE', {asNumber:true}) || 0);
    const platformFees = Number(getCell(r, 'PLATFORM FEES', {asNumber:true}) || 0);
    const buy = Number(getCell(r, 'PRODUCT BUY PRICE', {asNumber:true}) || 0);
    const explicitProfit = Number(getCell(r, 'PROFITS', {asNumber:true}));
    const profit = (!isNaN(explicitProfit) && explicitProfit !== 0) ? explicitProfit : (sell - buy - platformFees || 0);

    // revenue as sell (you can change to sell-platformFees if you prefer)
    const revenue = sell;

    revenueByDate[iso] = (revenueByDate[iso] || 0) + revenue;
    salesByDate[iso] = (salesByDate[iso] || 0) + 1;
    totalRevenue += revenue;
    totalSales += 1;
    totalProfit += profit;

    const product = getCell(r, 'PRODUCT NAME') || getCell(r,'PRODUCT') || '';
    if(product) productsSet.add(product);
  });

  const labels = Object.keys(revenueByDate).filter(d=>d!=='unknown').sort();
  if(Object.keys(revenueByDate).includes('unknown')) labels.push('unknown');

  const revenueData = labels.map(l => revenueByDate[l] || 0);
  const salesData = labels.map(l => salesByDate[l] || 0);

  const aov = totalSales ? (totalRevenue / totalSales) : 0;
  document.getElementById('analyticsTotalRevenue').innerText = formatINR(totalRevenue);
  document.getElementById('analyticsTotalSales').innerText = String(totalSales);
  document.getElementById('analyticsAOV').innerText = formatINR(aov);
  // updated: show total profit in the analytics summary (requested)
  document.getElementById('analyticsTotalProfit').innerText = formatINR(totalProfit);

  const canvas = document.getElementById('analyticsChart');
  if(!canvas) return;
  if(analyticsChart) analyticsChart.destroy();

  const maxRevenue = revenueData.length ? Math.max(...revenueData) : 0;
  analyticsChart = new Chart(canvas.getContext('2d'), {
    type:'line',
    data:{
      labels: labels,
      datasets:[
        {
          label: 'Revenue',
          data: revenueData,
          borderColor: 'rgba(16,123,215,0.95)',
          backgroundColor: 'rgba(16,123,215,0.12)',
          fill: true,
          yAxisID: 'y',
          tension: 0.25,
          pointRadius: 4
        },
        {
          label: 'Sales',
          data: salesData,
          borderColor: 'rgba(120,120,245,0.9)',
          backgroundColor: 'rgba(120,120,245,0.08)',
          fill: true,
          yAxisID: 'y1',
          tension: 0.25,
          pointRadius: 3
        }
      ]
    },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      interaction:{ mode:'index', intersect:false },
      plugins:{ legend:{ position:'top' } },
      scales:{
        x:{ grid:{ color: 'rgba(0,0,0,0.03)' }, ticks:{ maxRotation:0 } },
        y:{
          type:'linear',
          position:'left',
          ticks:{ callback: v => (typeof v === 'number' ? formatINR(v) : v) },
          grid:{ color: 'rgba(0,0,0,0.03)' },
          beginAtZero:true,
          suggestedMax: Math.ceil(maxRevenue * 1.25) || 10
        },
        y1:{
          type:'linear',
          position:'right',
          grid:{ drawOnChartArea:false },
          beginAtZero:true,
          ticks:{ callback: v => String(v) }
        }
      }
    }
  });
}

/* ---------- search ---------- */
const searchInput = document.getElementById('customerSearch');
const clearBtn = document.getElementById('clearSearch');
let searchTimer = null;
if(searchInput){
  searchInput.addEventListener('input', (e) => {
    if(searchTimer) clearTimeout(searchTimer);
    searchTimer = setTimeout(() => {
      const q = (e.target.value || "").trim().toLowerCase();
      filterCustomerRows(q);
    }, 160);
  });
}
if(clearBtn){
  clearBtn.addEventListener('click', () => {
    if(searchInput) searchInput.value = "";
    filterCustomerRows("");
  });
}

function filterCustomerRows(query){
  const tbody = document.querySelector("#customerTable tbody");
  if(!tbody) return;
  tbody.innerHTML = "";
  const rowsToShow = [];
  for(let i=0;i<customerRowsCache.length;i++){
    const r = customerRowsCache[i];
    const name = (r.c?.[1]?.v || "").toString().toLowerCase();
    if(!query || name.includes(query)) rowsToShow.push({r, idx:i});
  }
  rowsToShow.forEach(item => {
    const r = item.r;
    const idx = item.idx;
    const dt = parseDT(r.c?.[ headerIndex['TIMESTAMP'] ]);
    const customer = String(getCell(r, 'NAME OF CUSTOMER') || getCell(r, 'NAME') || '');
    const product = String(getCell(r, 'PRODUCT NAME') || getCell(r, 'PRODUCT') || '');
    const price = Number(getCell(r, 'PRODUCT SELL PRICE', {asNumber:true}) || 0);
    const platformFees = Number(getCell(r, 'PLATFORM FEES', {asNumber:true}) || 0);
    const explicitProfit = Number(getCell(r, 'PROFITS', {asNumber:true}));
    const profit = (!isNaN(explicitProfit) && explicitProfit !== 0) ? explicitProfit : (price - Number(getCell(r,'PRODUCT BUY PRICE',{asNumber:true})||0) - platformFees);
    const sheetRow = idx + 2;
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="col-number"><a class="row-link" data-row="${sheetRow}">${sheetRow}</a></td>
      <td>${escapeHtml(customer)}</td>
      <td>${escapeHtml(product)}</td>
      <td class="col-profit">${formatINR(price)}</td>
      <td class="col-profit">${formatINR(platformFees)}</td>
      <td class="col-profit">${formatINR(profit)}</td>
      <td class="col-date">${escapeHtml(dt.date)}</td>
    `;
    tbody.appendChild(tr);
  });
  wireRowLinks();
}

/* ---------- row link wiring (open invoice) ---------- */
function wireRowLinks(){
  document.querySelectorAll('.row-link').forEach(el=>{
    el.removeEventListener('click', onRowClick);
    el.addEventListener('click', onRowClick);
  });
}

function onRowClick(ev){
  const row = ev.currentTarget.getAttribute('data-row');
  if(!row) return;
  openInvoiceForRow(Number(row));
}

/* open invoice in iframe and show invoice view; also open new tab as convenience */
function openInvoiceForRow(rowNumber){
  const baseUrl = "https://viraj69rip.github.io/Invoice-From-Void-PC-Games/";
  const urlWithRow = baseUrl + (baseUrl.includes('?') ? '&' : '?') + 'row=' + encodeURIComponent(rowNumber);
  const iframe = document.getElementById('invoiceIframe');
  if(iframe){
    iframe.src = urlWithRow;
  }
  showView('invoice');
  window.open(urlWithRow, '_blank');
}

/* ---------- Sheet embed handling ---------- */
const sheetIframe = document.getElementById('sheetIframe');
const openSheetBtn = document.getElementById('openSheetBtn');

function loadSheetEmbed(){
  if(!sheetIframe) return;
  sheetIframe.src = PUBLISHED_SHEET_URL;
}
if(openSheetBtn){
  openSheetBtn.addEventListener('click', ()=> {
    window.open(PUBLISHED_SHEET_URL, '_blank');
  });
}

/* keyboard nav - 1..6 (6 = analytics) */
document.addEventListener('keydown', (e)=>{
  if(e.key === '1') showView('dashboard');
  if(e.key === '2') showView('customer');
  if(e.key === '3') showView('entry');
  if(e.key === '4') showView('invoice');
  if(e.key === '5') showView('sheet');
  if(e.key === '6') showView('analytics');
});

/* initial */
Object.values(views).forEach(v => { if(v && v.id !== 'view-dashboard') v.style.display='none'; });
showView('dashboard');
</script>
</body>
</html>
