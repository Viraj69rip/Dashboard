<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Void Store Dashboard</title>

  <link rel="icon" href="https://i.ibb.co/sJqfn3w5/1761541971985.png" type="image/png">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --accent:#10a37f;
      --muted:#9aa1a6;
      --bg:#e4e7eb;
      --glass: rgba(255,255,255,0.36);
      --glass-2: rgba(255,255,255,0.22);
      --card-border: rgba(255,255,255,0.36);
      --nav-width: 220px;
    }

    *{box-sizing:border-box;font-family:Inter,system-ui,Arial,Helvetica,sans-serif}
    html,body{height:100%;margin:0;background:linear-gradient(135deg,#c9d6ff 0%, #e2e2f0 100%);color:#222}
    h1,h2,h3,h4,h5,h6{margin:0;padding:0}
    button{cursor:pointer}

    /* layout */
    .layout{display:flex;min-height:100vh;align-items:stretch}
    .sidebar{
      width:var(--nav-width);padding:26px;border-right:1px solid rgba(255,255,255,0.28);
      background:var(--glass-2);backdrop-filter:blur(10px);flex-shrink:0;
      box-shadow: 0 6px 20px rgba(12,24,40,0.03);position:relative;
    }
    .logo{display:flex;align-items:center;gap:10px;font-weight:800;color:var(--accent);margin-bottom:20px;font-size:18px}
    .logo img{height:36px;width:36px;border-radius:8px;object-fit:cover;box-shadow:0 4px 12px rgba(0,0,0,0.08)}
    .nav a{
      display:block;padding:10px 8px;border-radius:10px;text-decoration:none;margin-bottom:8px;color:#223;font-weight:600;
      transition:all .22s ease;
    }
    .nav a:hover{transform:translateX(6px);opacity:.95}
    .nav a.active{background:rgba(16,163,127,0.16);color:var(--accent);box-shadow: inset 0 -2px 0 rgba(0,0,0,0.02)}

    .main{flex:1;padding:26px 34px;min-width:0;min-height:100vh}

    /* top cards */
    .top{display:flex;gap:18px;flex-wrap:wrap;margin-bottom:18px}
    .card{
      flex:1;min-width:180px;padding:18px;border-radius:14px;border:1px solid var(--card-border);
      background:var(--glass);backdrop-filter:blur(10px);box-shadow: 0 8px 30px rgba(20,30,60,0.04);
    }
    .card h4{margin:0;color:#445;font-size:14px;font-weight:700}
    .big{font-size:20px;margin-top:8px;font-weight:800}

    .content{display:flex;gap:20px;align-items:flex-start}
    .left{flex:1;min-width:0}
    .right{width:360px;flex-shrink:0}

    /* panels */
    .panel{
      background:var(--glass);border:1px solid var(--card-border);backdrop-filter:blur(12px);
      padding:18px;border-radius:14px;margin-bottom:18px;box-shadow:0 6px 20px rgba(0,0,0,0.04);
    }
    .panel h3{font-size:18px;margin-bottom:12px;color:#1f2937}

    /* table */
    table{width:100%;border-collapse:collapse;margin-top:8px;table-layout:fixed}
    thead th{
      padding:12px 12px;font-size:13px;color:#475569;border-bottom:1px solid rgba(0,0,0,0.05);
      text-align:left;font-weight:700; background:transparent;
    }
    tbody td{
      padding:14px 12px;border-bottom:1px solid rgba(0,0,0,0.03);font-size:14px;color:#28343a;vertical-align:middle;
    }
    tbody tr:hover td{ background: rgba(255,255,255,0.28); transform: translateX(2px); }

    /* column widths */
    thead th:nth-child(1), tbody td:nth-child(1){ width:6%; text-align:center }
    thead th:nth-child(2), tbody td:nth-child(2){ width:38%; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    thead th:nth-child(3), tbody td:nth-child(3){ width:18%; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; } /* status */
    thead th:nth-child(4), tbody td:nth-child(4){ width:12%; text-align:right; padding-right:22px; } /* profit */
    thead th:nth-child(5), tbody td:nth-child(5){ width:12%; text-align:right; padding-right:22px; } /* platform fees */
    thead th:nth-child(6), tbody td:nth-child(6){ width:18%; text-align:right; padding-left:18px; color:#4b5563; } /* date */

    .col-number{ font-weight:700; color:#374151; }
    .col-profit{ text-align:right; padding-right:22px; font-weight:600 }
    .col-date{ font-size:13px; color:#374151; white-space:nowrap; text-align:right }

    /* badges */
    .status-badge{padding:6px 12px;border-radius:12px;font-weight:700;font-size:13px;display:inline-block}
    .status-paid{background:rgba(16,163,127,0.12);color:#056a52;border:1px solid rgba(16,163,127,0.09)}
    .status-pending{background:rgba(244,197,61,0.12);color:#8b5e00;border:1px solid rgba(244,197,61,0.08)}
    .status-active{background:rgba(16,163,127,0.12);color:#056a52;border:1px solid rgba(16,163,127,0.09)}

    /* search */
    .search-row{display:flex;gap:10px;align-items:center;margin-bottom:12px}
    .search-input{flex:1;padding:12px 14px;border-radius:12px;border:1px solid rgba(0,0,0,0.04);background:rgba(255,255,255,0.28);}

    .row-link{display:inline-block;padding:6px 8px;border-radius:8px;background:rgba(255,255,255,0.12);border:1px solid rgba(0,0,0,0.04);font-weight:700;color:#0a2540;text-decoration:none;cursor:pointer;}

    /* iframe */
    .iframe-container{position:relative;width:100%;min-height:420px;overflow:hidden;border-radius:12px;border:1px solid var(--card-border);background:var(--glass-2);padding:12px}
    .iframe-inner{width:100%;height:640px;border:0;display:block}

    /* overlay (shown while iframe loading or blocked) */
    .sheet-overlay{
      position:absolute;inset:0;display:flex;align-items:center;justify-content:center;padding:18px;
      background:linear-gradient(180deg, rgba(255,255,255,0.9), rgba(255,255,255,0.85));
      border-radius:12px;z-index:40;text-align:center;
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.2);
    }
    .sheet-overlay p{margin:0 0 12px;color:#274155}
    .sheet-overlay .btn{display:inline-block;padding:10px 14px;border-radius:10px;background:#fff;border:1px solid rgba(0,0,0,0.06);box-shadow:0 6px 20px rgba(0,0,0,0.04);cursor:pointer}

    /* responsive / mobile */
    .top, .content{transition:all .18s ease}
    @media(max-width:1000px){
      .right{width:320px}
      .top{gap:12px}
    }
    @media(max-width:900px){
      /* collapse sidebar into top bar */
      .layout{flex-direction:column}
      .sidebar{position:fixed;left:0;top:0;bottom:0;width:var(--nav-width);transform:translateX(-100%);transition:transform .18s ease;z-index:60}
      .sidebar.open{transform:translateX(0)}
      .main{margin-left:0;padding:18px}
      /* show small top bar with hamburger */
      .topbar{display:flex;align-items:center;gap:12px;padding:12px}
      .logo{margin:0}
      .hamburger{width:42px;height:42px;border-radius:10px;background:var(--glass);display:flex;align-items:center;justify-content:center;box-shadow:0 6px 20px rgba(0,0,0,0.04);cursor:pointer}
      .content{flex-direction:column}
      .right{width:100%}
      .iframe-inner{height:420px}
      .iframe-container{min-height:300px}
      table{font-size:13px}
      /* make cards full width stacked */
      .top { flex-direction:column; }
    }

    /* small tweaks for charts and legend */
    .chart-wrap{width:100%;height:320px}
    @media(max-width:420px){ .chart-wrap{height:260px} }

    /* visually hide duplicate text issue safeguard */
    .nav-text-guard { display:none; } /* in case some stray element exists */
  </style>
</head>
<body>
  <div class="layout">
    <aside class="sidebar" id="sidebar">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:14px">
        <div class="logo"><img src="https://i.ibb.co/sJqfn3w5/1761541971985.png" alt="Void Logo"><span>Void Store</span></div>
      </div>

      <nav class="nav" aria-label="main nav" id="mainNav">
        <a id="nav-dashboard" class="active" role="button">Dashboard</a>
        <a id="nav-customer" role="button">Customer Data</a>
        <a id="nav-entry" role="button">Entry Form</a>
        <a id="nav-invoice" role="button">Invoice Generator</a>
        <a id="nav-sheet" role="button">Sheet View</a>
        <a id="nav-analytics" role="button">Analytics</a>
      </nav>
    </aside>

    <main class="main" id="main">
      <!-- topbar for small screens -->
      <div class="topbar" id="topbar" style="display:none">
        <div class="hamburger" id="hamburger" title="Menu">
          <svg width="18" height="14" viewBox="0 0 18 14" fill="none" xmlns="http://www.w3.org/2000/svg"><rect width="18" height="2" rx="1" fill="#1f2d3d"/><rect y="6" width="18" height="2" rx="1" fill="#1f2d3d"/><rect y="12" width="18" height="2" rx="1" fill="#1f2d3d"/></svg>
        </div>
        <div style="font-weight:800;font-size:18px">Void Store</div>
      </div>

      <!-- Dashboard -->
      <section id="view-dashboard" class="view" aria-hidden="true">
        <div class="top">
          <div class="card"><h4>Total Earning</h4><div class="big" id="totalEarning">₹ 0.00</div></div>
          <div class="card"><h4>Total Orders</h4><div class="big" id="totalOrders">0</div></div>
          <div class="card"><h4>Total Profit</h4><div class="big" id="totalProfitTop">₹ 0.00</div></div>
        </div>

        <div class="content">
          <div class="left">
            <div class="panel">
              <h3>Active Listing</h3>
              <table id="entriesTableDashboard" aria-describedby="Active Listing">
                <thead>
                  <tr>
                    <th>No.</th>
                    <th>Sub. Name</th>
                    <th>Status</th>
                    <th style="text-align:right">Profit</th>
                    <th style="text-align:right">Platform Fees</th>
                    <th class="col-date">Date</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>

          <aside class="right">
            <div class="panel">
              <h3>Top sellers (top 4 + Other)</h3>
              <div style="position:relative">
                <canvas id="topSellersPie" style="height:220px;width:100%"></canvas>
              </div>
            </div>

            <div class="panel">
              <h3>Overview</h3>
              <p class="small">Total Entries: <b id="countEntries">0</b></p>
              <p class="small">Total Profit: <b id="totalProfit">₹ 0.00</b></p>
            </div>
          </aside>
        </div>
      </section>

      <!-- Customer Data -->
      <section id="view-customer" class="view" aria-hidden="true">
        <div class="panel">
          <h3>Customer Data</h3>
          <div class="search-row">
            <input id="customerSearch" class="search-input" placeholder="Search customer..." />
            <button id="clearSearch" style="padding:10px 14px;border-radius:10px;border:1px solid rgba(0,0,0,0.04);background:var(--glass-2)">Clear</button>
          </div>

          <div style="overflow:auto">
            <table id="customerTable" aria-describedby="Customer Data">
              <thead>
                <tr>
                  <th>No.</th>
                  <th>Customer</th>
                  <th>Product</th>
                  <th style="text-align:right">Price</th>
                  <th style="text-align:right">Platform Fees</th>
                  <th style="text-align:right">Profit</th>
                  <th class="col-date">Date</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- Entry Form -->
      <section id="view-entry" class="view" aria-hidden="true">
        <div class="panel">
          <h3>Entry Form</h3>
          <div class="iframe-container">
            <iframe class="iframe-inner" src="https://docs.google.com/forms/d/e/1FAIpQLSeOAk5-YgxpVINsL6v3_c2ggwS_MZ_iDQRz1679hAxW6DcgUw/viewform?embedded=true" title="Entry Form"></iframe>
          </div>
        </div>
      </section>

      <!-- Invoice -->
      <section id="view-invoice" class="view" aria-hidden="true">
        <div class="panel">
          <h3>Invoice Generator</h3>
          <div class="iframe-container">
            <iframe id="invoiceIframe" class="iframe-inner" src="https://viraj69rip.github.io/Invoice-From-Void-PC-Games/" title="Invoice Generator - Void PC Games"></iframe>
          </div>
        </div>
      </section>

      <!-- Sheet -->
      <section id="view-sheet" class="view" aria-hidden="true">
        <div class="panel">
          <h3>Sheet View (embedded)</h3>
          <div style="display:flex;gap:10px;align-items:center;margin-bottom:10px">
            <button id="openSheetBtn" style="padding:8px 12px;border-radius:8px;border:1px solid rgba(0,0,0,0.05);background:var(--glass-2)">Open Sheet in new tab</button>
            <span class="small" style="color:#475569">Published view is embedded below.</span>
          </div>

          <div class="iframe-container" id="sheetFrameWrap" style="min-height:560px;position:relative">
            <iframe id="sheetIframe" class="iframe-inner" src="" title="Google Sheet - embedded" allowfullscreen></iframe>

            <!-- overlay: visible until iframe 'load' fires (or if blocked) -->
            <div id="sheetOverlay" class="sheet-overlay" aria-hidden="false" style="display:flex;flex-direction:column;gap:10px;align-items:center;justify-content:center">
              <p><strong>If the sheet does not appear below:</strong><br>
                 • Make sure you used **File → Publish to the web…** for the specific sheet (not just "share").<br>
                 • If embedding is blocked by browser/privacy extension, open in a new tab.</p>
              <div style="display:flex;gap:8px;align-items:center">
                <button class="btn" id="overlayOpenBtn">Open published sheet in new tab</button>
                <button class="btn" id="overlayHideBtn">Hide this message</button>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Analytics -->
      <section id="view-analytics" class="view" aria-hidden="true">
        <div class="panel">
          <h3>Analytics</h3>
          <p class="small">Overview and sales timeline</p>

          <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-top:12px;margin-bottom:18px">
            <div class="card"><h4>Total revenues</h4><div class="big" id="analyticsTotalRevenue">₹ 0.00</div></div>
            <div class="card"><h4>Total sales</h4><div class="big" id="analyticsTotalSales">0</div></div>
            <div class="card"><h4>AOV</h4><div class="big" id="analyticsAOV">₹ 0.00</div></div>
            <div class="card"><h4>Total Profit</h4><div class="big" id="analyticsTotalProfit">₹ 0.00</div></div>
          </div>

          <div class="panel" style="padding:12px">
            <h3 style="margin-bottom:8px">Sales timeline</h3>
            <div class="chart-wrap"><canvas id="analyticsChart"></canvas></div>
          </div>
        </div>
      </section>

    </main>
  </div>

<script>
/* ---------- config ---------- */
/*
  NOTE: this is the published sheet URL (pubhtml). If you haven't published the sheet,
  open your sheet -> File -> Publish to the web -> pick the sheet tab -> Publish,
  then copy the "Link" Google provides (pubhtml). The link below is the one used
  in previous messages; if you published a different sheet tab replace this string.
*/
const PUBLISHED_SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTP0XFeoA6vDt9mdjZyoXnUDBw3Whx5epnX0zvhvSdGDwnvQ7jBm-vEtHlzDA1q1nGCVxYVsanny9Ik/pubhtml?gid=2126430015&single=true";
// add widget params for cleaner embed
const PUBLISHED_SHEET_EMBED = PUBLISHED_SHEET_URL + "&widget=true&chrome=false";

/* ---- helpers (unchanged) ---- */
function escapeHtml(s){ return (s||"").toString().replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function formatINR(n){ return "₹ "+Number(n||0).toLocaleString("en-IN",{minimumFractionDigits:2}); }
function parseGoogleJSON(txt){ const s=txt.indexOf("{"), e=txt.lastIndexOf("}"); return JSON.parse(txt.slice(s,e+1)); }
function parseDT(cell){
  if(!cell) return {date:"", time:""};
  if(typeof cell.f === 'string'){
    const f = cell.f.trim();
    let m = f.match(/(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})(?:\s+(\d{1,2}:\d{2}(?::\d{2})?))?/);
    if(m){
      const d = m[1].padStart(2,'0'), mo = m[2].padStart(2,'0'), yy = (String(m[3]).length===4?String(m[3]).slice(2):String(m[3]).padStart(2,'0'));
      const time = m[4] || "";
      return { date: `${d}/${mo}/${yy}`, time };
    }
    if(f.includes("Date(")){
      const nums = (f.match(/\d+/g)||[]).map(Number);
      if(nums.length >= 3){
        const y = nums[0], m0 = nums[1], d = nums[2];
        const hh = nums[3]||0, mm = nums[4]||0, ss = nums[5]||0;
        const mo = String(m0+1).padStart(2,'0');
        return { date: `${String(d).padStart(2,'0')}/${mo}/${String(y).slice(2)}`, time: `${String(hh).padStart(2,'0')}:${String(mm).padStart(2,'0')}:${String(ss).padStart(2,'0')}` };
      }
    }
  }
  if(typeof cell.v === 'string'){
    const s = cell.v.trim();
    const iso = s.match(/^(\d{4})-(\d{2})-(\d{2})[T ](\d{2}):(\d{2}):(\d{2})/);
    if(iso){
      const y = iso[1], mo = iso[2], d = iso[3], hh = iso[4], mm = iso[5], ss = iso[6];
      return { date: `${d}/${mo}/${y.slice(2)}`, time: `${hh}:${mm}:${ss}` };
    }
    const m2 = s.match(/(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})(?:\s+(\d{1,2}:\d{2}(?::\d{2})?))?/);
    if(m2){
      const d = m2[1].padStart(2,'0'), mo = m2[2].padStart(2,'0'), yy = (String(m2[3]).length===4?String(m2[3]).slice(2):String(m2[3]).padStart(2,'0'));
      return { date: `${d}/${mo}/${yy}`, time: (m2[4]||"") };
    }
  }
  return { date:"", time:"" };
}

/* ---------- view & nav ---------- */
const views = {
  dashboard: document.getElementById('view-dashboard'),
  customer: document.getElementById('view-customer'),
  entry: document.getElementById('view-entry'),
  invoice: document.getElementById('view-invoice'),
  sheet: document.getElementById('view-sheet'),
  analytics: document.getElementById('view-analytics')
};
const navEls = {
  dashboard: document.getElementById('nav-dashboard'),
  customer: document.getElementById('nav-customer'),
  entry: document.getElementById('nav-entry'),
  invoice: document.getElementById('nav-invoice'),
  sheet: document.getElementById('nav-sheet'),
  analytics: document.getElementById('nav-analytics')
};

function hideAllViews(){
  Object.values(views).forEach(v => {
    v.classList.remove('active');
    if(v) { v.style.display='none'; v.setAttribute('aria-hidden','true'); }
  });
  Object.values(navEls).forEach(n => n.classList.remove('active'));
}

function showView(name){
  hideAllViews();
  const next = views[name];
  if(next){
    next.style.display='block';
    void next.offsetHeight;
    next.classList.add('active');
    next.setAttribute('aria-hidden','false');
  }
  if(navEls[name]) navEls[name].classList.add('active');

  // lazy actions
  if(name === 'dashboard') fetchAndRender();
  if(name === 'sheet') loadSheetEmbed();
  if(name === 'analytics') { fetchAndRender(); renderAnalyticsFromCache(); } // reuse cache
  // close mobile sidebar when selecting on small screens
  if(window.innerWidth < 900) document.getElementById('sidebar').classList.remove('open');
}

Object.keys(navEls).forEach(k => {
  navEls[k].addEventListener('click', ()=> showView(k));
});

/* ---------- fetch & render (robust header lookup) ---------- */
let customerRowsCache = []; // will hold original array from sheet
let headerIndex = {};       // header label (upper) => index in r.c[]

function buildHeaderMap(json){
  headerIndex = {};
  if(!json || !json.table || !Array.isArray(json.table.cols)) return;
  json.table.cols.forEach((col, i) => {
    const label = (col.label || '').toString().trim().toUpperCase();
    if(label) headerIndex[label] = i;
  });
}

function getCell(row, hdr, options = {}){
  if(!row) return options.asNumber ? 0 : '';
  const idx = headerIndex[hdr.toUpperCase()];
  if(idx === undefined) {
    return options.asNumber ? 0 : '';
  }
  const cell = row.c?.[idx];
  if(!cell) return options.asNumber ? 0 : '';
  if(options.asNumber){
    const v = Number(cell.v ?? 0);
    return isNaN(v) ? 0 : v;
  }
  return cell.v ?? (cell.f ?? '');
}

/* ---------- FETCH - uses gviz JSON endpoint ---------- */
const SHEET_ID = "1Eat5aTUzw6Ck2fZG-Vf_d1g9WAMFTlNcZd0yLiotUJw";
const SHEET_NAME = "Form responses 1";
const FEED_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(SHEET_NAME)}`;

function fetchAndRender(){
  fetch(FEED_URL).then(r => r.text()).then(txt => {
    try {
      const json = parseGoogleJSON(txt);
      buildHeaderMap(json);
      const rows = json.table.rows || [];
      customerRowsCache = rows.slice();
      renderDashboard(rows);
      renderCustomer(rows);
      renderAnalyticsFromCache();
      renderTopSellersPie(rows);
    } catch(e){
      console.error("Failed to parse sheet JSON:", e);
    }
  }).catch(err=>{
    console.error("Sheet fetch error:", err);
  });
}

/* initial fetch */
fetchAndRender();

/* ---------- badges ---------- */
function badge(status){
  if(!status) return '';
  const s = status.toString().toLowerCase();
  if(s.includes('pending')) return `<span class="status-badge status-pending">Pending</span>`;
  if(s.includes('paid')) return `<span class="status-badge status-paid">Paid</span>`;
  if(s.includes('active')) return `<span class="status-badge status-active">Active</span>`;
  return escapeHtml(status);
}

/* ---------- animate numbers ---------- */
function animateValue(element, start, end, duration = 800, formatter = (n)=>String(n)) {
  const startTime = performance.now();
  const isInt = Number.isInteger(start) && Number.isInteger(end);
  function easeOutCubic(t){ return 1 - Math.pow(1 - t, 3); }
  function step(now) {
    const elapsed = now - startTime;
    const progress = Math.min(1, elapsed / duration);
    const eased = easeOutCubic(progress);
    const current = start + (end - start) * eased;
    element.textContent = formatter(isInt ? Math.round(current) : current);
    if(progress < 1) requestAnimationFrame(step);
  }
  requestAnimationFrame(step);
}

/* ---------- renderDashboard ---------- */
let _profitChart = null;
function renderDashboard(rows){
  const tbody = document.querySelector("#entriesTableDashboard tbody");
  tbody.innerHTML = "";
  let totalEarning = 0, totalProfit = 0;
  const productProfit = {};

  rows.forEach((r, idx) => {
    const dtCell = r.c?.[ headerIndex['TIMESTAMP'] ];
    const dt = parseDT(dtCell);
    const product = String(getCell(r, 'PRODUCT NAME') || getCell(r, 'PRODUCT') || '').toString();
    const buy = Number(getCell(r, 'PRODUCT BUY PRICE', {asNumber:true}) || 0);
    const sell = Number(getCell(r, 'PRODUCT SELL PRICE', {asNumber:true}) || 0);
    const platformFees = Number(getCell(r, 'PLATFORM FEES', {asNumber:true}) || 0);
    const status = String(getCell(r, 'PAYMENT STATUS') || getCell(r, 'STATUS') || '');

    const explicitProfit = Number(getCell(r, 'PROFITS', {asNumber:true}));
    const profit = (!isNaN(explicitProfit) && explicitProfit !== 0) ? explicitProfit : (sell - buy - platformFees || 0);

    totalEarning += sell;
    totalProfit += profit;
    productProfit[product] = (productProfit[product] || 0) + profit;

    const sheetRow = idx + 2;
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="col-number"><a class="row-link" data-row="${sheetRow}">${sheetRow}</a></td>
      <td>${escapeHtml(product)}</td>
      <td>${badge(status)}</td>
      <td class="col-profit">${formatINR(profit)}</td>
      <td class="col-profit">${formatINR(platformFees)}</td>
      <td class="col-date">${escapeHtml(dt.date)}</td>
    `;
    tbody.appendChild(tr);
  });

  // animate top cards
  const totalEarningEl = document.getElementById('totalEarning');
  const totalOrdersEl = document.getElementById('totalOrders');
  const totalProfitTopEl = document.getElementById('totalProfitTop');

  animateValue(totalEarningEl, 0, totalEarning, 900, (n)=>formatINR(n));
  animateValue(totalOrdersEl, 0, rows.length, 700, (n)=>String(n));
  animateValue(totalProfitTopEl, 0, totalProfit, 900, (n)=>formatINR(n));

  document.getElementById('countEntries').innerText = rows.length;
  const totalProfitEl = document.getElementById('totalProfit');
  if(totalProfitEl) totalProfitEl.innerText = formatINR(totalProfit);

  // we intentionally call top-sellers pie separately
  renderProfitByProductChart(productProfit);
  wireRowLinks();
}

/* ---------- renderCustomer ---------- */
function renderCustomer(rows){
  const tbody = document.querySelector("#customerTable tbody");
  tbody.innerHTML = "";
  rows.forEach((r, idx) => {
    const dt = parseDT(r.c?.[ headerIndex['TIMESTAMP'] ]);
    const customer = String(getCell(r, 'NAME OF CUSTOMER') || getCell(r, 'NAME') || '');
    const product = String(getCell(r, 'PRODUCT NAME') || getCell(r, 'PRODUCT') || '');
    const price = Number(getCell(r, 'PRODUCT SELL PRICE', {asNumber:true}) || 0);
    const platformFees = Number(getCell(r, 'PLATFORM FEES', {asNumber:true}) || 0);
    const explicitProfit = Number(getCell(r, 'PROFITS', {asNumber:true}));
    const profit = (!isNaN(explicitProfit) && explicitProfit !== 0) ? explicitProfit : (price - Number(getCell(r,'PRODUCT BUY PRICE',{asNumber:true})||0) - platformFees);

    const sheetRow = idx + 2;
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="col-number"><a class="row-link" data-row="${sheetRow}">${sheetRow}</a></td>
      <td>${escapeHtml(customer)}</td>
      <td>${escapeHtml(product)}</td>
      <td class="col-profit">${formatINR(price)}</td>
      <td class="col-profit">${formatINR(platformFees)}</td>
      <td class="col-profit">${formatINR(profit)}</td>
      <td class="col-date">${escapeHtml(dt.date)}</td>
    `;
    tbody.appendChild(tr);
  });
  wireRowLinks();
}

/* ---------- profit by product chart (bar) ---------- */
function renderProfitByProductChart(obj){
  const ctx = document.getElementById("profitChart");
  // profitChart might not exist in this layout (we replaced with pie). keep defensive:
  if(!ctx) return;
  const ctx2 = ctx.getContext("2d");
  if(_profitChart) _profitChart.destroy();
  _profitChart = new Chart(ctx2,{
    type:'bar',
    data:{
      labels:Object.keys(obj),
      datasets:[{ label:'Profit', data:Object.values(obj).map(v=>Number(v.toFixed? v : v)), backgroundColor:'rgba(75,192,150,0.8)' }]
    },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      plugins:{ legend:{ display:false } },
      scales:{ y:{ beginAtZero:true } }
    }
  });
}

/* ---------- Top sellers pie (top 4 + other) ---------- */
let topSellersChart = null;
function renderTopSellersPie(rows){
  // aggregate by product (use count of sales as "size" — or sum of revenue if you prefer)
  const byProduct = {};
  rows.forEach(r=>{
    const name = String(getCell(r, 'PRODUCT NAME') || getCell(r, 'PRODUCT') || 'Unknown');
    const price = Number(getCell(r, 'PRODUCT SELL PRICE', {asNumber:true}) || 0);
    // we'll use revenue sum so bigger revenue = bigger slice
    byProduct[name] = (byProduct[name] || 0) + price;
  });

  // build sorted list by value
  const entries = Object.entries(byProduct).sort((a,b)=>b[1]-a[1]);
  const top = entries.slice(0,4);
  const others = entries.slice(4);
  const labels = top.map(e=>e[0]);
  const data = top.map(e=>e[1]);
  const othersSum = others.reduce((s,e)=>s+e[1],0);
  if(othersSum > 0){
    labels.push('Other');
    data.push(othersSum);
  }

  // colors
  const colors = [
    'rgba(75,192,192,0.9)',
    'rgba(54,162,235,0.9)',
    'rgba(255,205,86,0.9)',
    'rgba(153,102,255,0.9)',
    'rgba(201,203,207,0.9)'
  ];

  const ctx = document.getElementById('topSellersPie').getContext('2d');
  if(topSellersChart) topSellersChart.destroy();
  topSellersChart = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels,
      datasets: [{
        data,
        backgroundColor: colors.slice(0, labels.length),
        borderWidth: 0
      }]
    },
    options: {
      responsive:true,
      maintainAspectRatio:false,
      cutout: '65%',
      plugins: {
        legend: { position:'right' }
      }
    }
  });
}

/* ---------- search ---------- */
const searchInput = document.getElementById('customerSearch');
const clearBtn = document.getElementById('clearSearch');
let searchTimer = null;
if(searchInput){
  searchInput.addEventListener('input', (e) => {
    if(searchTimer) clearTimeout(searchTimer);
    searchTimer = setTimeout(() => {
      const q = (e.target.value || "").trim().toLowerCase();
      filterCustomerRows(q);
    }, 160);
  });
}
if(clearBtn){
  clearBtn.addEventListener('click', () => {
    if(searchInput) searchInput.value = "";
    filterCustomerRows("");
  });
}

function filterCustomerRows(query){
  const tbody = document.querySelector("#customerTable tbody");
  tbody.innerHTML = "";
  const rowsToShow = [];
  for(let i=0;i<customerRowsCache.length;i++){
    const r = customerRowsCache[i];
    const maybeName = (getCell(r,'NAME') || getCell(r,'NAME OF CUSTOMER') || r.c?.[1]?.v || "").toString().toLowerCase();
    if(!query || maybeName.includes(query)) rowsToShow.push({r, idx:i});
  }
  rowsToShow.forEach(item => {
    const r = item.r;
    const idx = item.idx;
    const dt = parseDT(r.c?.[ headerIndex['TIMESTAMP'] ]);
    const customer = String(getCell(r, 'NAME OF CUSTOMER') || getCell(r, 'NAME') || '');
    const product = String(getCell(r, 'PRODUCT NAME') || getCell(r, 'PRODUCT') || '');
    const price = Number(getCell(r, 'PRODUCT SELL PRICE', {asNumber:true}) || 0);
    const platformFees = Number(getCell(r, 'PLATFORM FEES', {asNumber:true}) || 0);
    const explicitProfit = Number(getCell(r, 'PROFITS', {asNumber:true}));
    const profit = (!isNaN(explicitProfit) && explicitProfit !== 0) ? explicitProfit : (price - Number(getCell(r,'PRODUCT BUY PRICE',{asNumber:true})||0) - platformFees);
    const sheetRow = idx + 2;
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="col-number"><a class="row-link" data-row="${sheetRow}">${sheetRow}</a></td>
      <td>${escapeHtml(customer)}</td>
      <td>${escapeHtml(product)}</td>
      <td class="col-profit">${formatINR(price)}</td>
      <td class="col-profit">${formatINR(platformFees)}</td>
      <td class="col-profit">${formatINR(profit)}</td>
      <td class="col-date">${escapeHtml(dt.date)}</td>
    `;
    tbody.appendChild(tr);
  });
  wireRowLinks();
}

/* ---------- row link wiring ---------- */
function wireRowLinks(){
  document.querySelectorAll('.row-link').forEach(el=>{
    el.removeEventListener('click', onRowClick);
    el.addEventListener('click', onRowClick);
  });
}

function onRowClick(ev){
  const row = ev.currentTarget.getAttribute('data-row');
  if(!row) return;
  openInvoiceForRow(Number(row));
}

/* open invoice */
function openInvoiceForRow(rowNumber){
  const baseUrl = "https://viraj69rip.github.io/Invoice-From-Void-PC-Games/";
  const urlWithRow = baseUrl + (baseUrl.includes('?') ? '&' : '?') + 'row=' + encodeURIComponent(rowNumber);
  const iframe = document.getElementById('invoiceIframe');
  if(iframe){
    iframe.src = urlWithRow;
  }
  showView('invoice');
  window.open(urlWithRow, '_blank');
}

/* ---------- Sheet embed logic + overlay fallback ---------- */
const sheetIframe = document.getElementById('sheetIframe');
const openSheetBtn = document.getElementById('openSheetBtn');
const sheetOverlay = document.getElementById('sheetOverlay');
const overlayOpenBtn = document.getElementById('overlayOpenBtn');
const overlayHideBtn = document.getElementById('overlayHideBtn');

function loadSheetEmbed(){
  if(!sheetIframe) return;
  // set src only once (lazy)
  if(!sheetIframe.dataset.srcset){
    sheetIframe.src = PUBLISHED_SHEET_EMBED;
    sheetIframe.dataset.srcset = "1";
  }
  // show overlay until iframe loads or user hides
  sheetOverlay.style.display = 'flex';
  sheetOverlay.setAttribute('aria-hidden','false');

  // install a one-time load handler to hide overlay if iframe loads successfully
  function onLoadOnce(){
    // loaded: hide overlay
    sheetOverlay.style.display = 'none';
    sheetOverlay.setAttribute('aria-hidden','true');
    sheetIframe.removeEventListener('load', onLoadOnce);
  }
  // attach load
  sheetIframe.addEventListener('load', onLoadOnce);

  // fallback: after 3.5s, if still showing overlay, keep it (user can open in new tab)
  setTimeout(()=> {
    if(sheetOverlay.style.display !== 'none'){
      // keep overlay visible — user can open sheet in new tab via button
      // (we do not auto-hide; overlay offers actions)
    }
  }, 3500);
}

if(openSheetBtn){
  openSheetBtn.addEventListener('click', ()=> {
    window.open(PUBLISHED_SHEET_EMBED, '_blank');
  });
}
if(overlayOpenBtn){
  overlayOpenBtn.addEventListener('click', ()=> {
    window.open(PUBLISHED_SHEET_EMBED, '_blank');
  });
}
if(overlayHideBtn){
  overlayHideBtn.addEventListener('click', ()=> {
    sheetOverlay.style.display = 'none';
    sheetOverlay.setAttribute('aria-hidden','true');
  });
}

/* ---------- Analytics rendering ---------- */
let analyticsChart = null;
function renderAnalyticsFromCache(){
  const rows = customerRowsCache || [];
  if(!rows) return;

  const byDate = {};
  let totalRevenue = 0, totalProfit = 0, totalSales = 0;
  rows.forEach(r=>{
    const dt = parseDT(r.c?.[ headerIndex['TIMESTAMP'] ]);
    const date = dt.date || 'Unknown';
    const price = Number(getCell(r, 'PRODUCT SELL PRICE', {asNumber:true}) || 0);
    const buy = Number(getCell(r, 'PRODUCT BUY PRICE', {asNumber:true}) || 0);
    const fees = Number(getCell(r, 'PLATFORM FEES', {asNumber:true}) || 0);
    const explicitProfit = Number(getCell(r, 'PROFITS', {asNumber:true}));
    const profit = (!isNaN(explicitProfit) && explicitProfit !== 0) ? explicitProfit : (price - buy - fees || 0);

    totalRevenue += price;
    totalProfit += profit;
    totalSales += 1;

    if(!byDate[date]) byDate[date] = { revenue:0, sales:0, profit:0 };
    byDate[date].revenue += price;
    byDate[date].sales += 1;
    byDate[date].profit += profit;
  });

  const dateKeys = Object.keys(byDate).sort((a,b)=>{
    function toIso(d){
      if(!d || d === 'Unknown') return '9999-99-99';
      const m = d.match(/(\d{2})\/(\d{2})\/(\d{2,4})/);
      if(!m) return d;
      const dd = m[1], mm = m[2], yy = m[3].length===2 ? ('20'+m[3]) : m[3];
      return `${yy}-${mm}-${dd}`;
    }
    return toIso(a) > toIso(b) ? 1 : -1;
  });

  const labels = dateKeys;
  const revenueData = labels.map(d => Number((byDate[d].revenue||0).toFixed(2)));
  const salesData = labels.map(d => byDate[d].sales||0);

  document.getElementById('analyticsTotalRevenue').textContent = formatINR(totalRevenue);
  document.getElementById('analyticsTotalSales').textContent = String(totalSales);
  document.getElementById('analyticsAOV').textContent = totalSales ? formatINR(totalRevenue/totalSales) : formatINR(0);
  document.getElementById('analyticsTotalProfit').textContent = formatINR(totalProfit);

  const ctx = document.getElementById('analyticsChart').getContext('2d');
  if(analyticsChart) analyticsChart.destroy();
  analyticsChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [
        {
          label: 'Revenue',
          data: revenueData,
          yAxisID: 'y',
          fill: true,
          tension: 0.3,
          pointRadius: 4,
          backgroundColor: 'rgba(16,163,127,0.12)',
          borderColor: 'rgba(16,163,127,0.9)'
        },
        {
          label: 'Sales',
          data: salesData,
          yAxisID: 'y1',
          fill: false,
          tension: 0.3,
          pointRadius: 4,
          borderColor: 'rgba(100,100,255,0.9)',
          backgroundColor: 'rgba(100,100,255,0.12)'
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode:'index', intersect:false },
      plugins: {
        legend: { position:'top' }
      },
      scales: {
        x: {
          ticks: { maxRotation:0, autoSkip:true, maxTicksLimit:6 }
        },
        y: {
          type: 'linear',
          position: 'left',
          ticks: { callback: v => '₹ '+Number(v).toLocaleString('en-IN') }
        },
        y1: {
          type: 'linear',
          position: 'right',
          grid: { drawOnChartArea: false },
          ticks: { stepSize:1 }
        }
      }
    }
  });
}

/* ---------- keyboard nav ---------- */
document.addEventListener('keydown', (e)=>{
  if(e.key === '1') showView('dashboard');
  if(e.key === '2') showView('customer');
  if(e.key === '3') showView('entry');
  if(e.key === '4') showView('invoice');
  if(e.key === '5') showView('sheet');
});

/* ---------- top sellers pie will be initially rendered once fetch completes ---------- */

/* ---------- initial UI setup ---------- */
function initialUI(){
  // show dashboard on load
  showView('dashboard');

  // mobile hamburger
  const hamburger = document.getElementById('hamburger');
  const sidebar = document.getElementById('sidebar');
  const topbar = document.getElementById('topbar');
  function updateResponsive(){
    if(window.innerWidth < 900){
      topbar.style.display = 'flex';
      sidebar.classList.remove('open');
    } else {
      topbar.style.display = 'none';
      sidebar.classList.remove('open');
    }
  }
  updateResponsive();
  window.addEventListener('resize', updateResponsive);
  if(hamburger){
    hamburger.addEventListener('click', ()=> {
      sidebar.classList.toggle('open');
    });
  }

  // prevent duplicate stray nav text: ensure nav is not copied elsewhere - guard
  document.querySelectorAll('.nav-text-guard').forEach(n=>n.remove());
}
initialUI();

/* expose fetch to console for debugging */
window.debugFetch = fetchAndRender;
</script>
</body>
</html>
